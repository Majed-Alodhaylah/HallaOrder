<!doctype html>
<html lang="ar" dir="rtl">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>فاتورة الطلب #{{ order.id }}</title>
  <style>
    body{margin:0;background:#f6f7fb;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1120px;margin:auto;padding:20px 16px}
    .card{background:#fff;border:1px solid #eef2f7;border-radius:14px}
    .alert{background:#f7f8fb;border:1px solid #eef2f7;border-radius:12px;padding:12px 14px;margin-bottom:18px}

    /* Progress */
    .progress{position:relative;display:flex;align-items:center;justify-content:space-between;margin:16px 0 22px}
    .progress::before{content:"";position:absolute;inset-inline:8px;top:50%;height:4px;background:#edf0f4;transform:translateY(-50%)}
    .node{position:relative;display:flex;flex-direction:column;align-items:center;gap:6px;padding-inline:8px;background:transparent;z-index:1}
    .dot{width:18px;height:18px;border-radius:999px;background:#e5e7eb;border:3px solid #e5e7eb}
    .node.is-active .dot{background:{{website.secondary_color}};border-color:{{website.secondary_color}}}
    .label{font-size:13px;color:#6b7280}

    /* Layout */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{min-height:260px}
    .side{display:flex;flex-direction:column;gap:14px}
    .section{background:#f7f8fb;border:1px solid #eef2f7;border-radius:12px;padding:12px}
    .summary{display:grid;grid-template-columns:auto 1fr;gap:6px}
    .muted{color:#6b7280}

    .footer{margin-top:20px;display:flex;justify-content:space-between}
    .btn{padding:12px 18px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;text-decoration:none;color:#111}
    /*.btn-primary{background:{{website.secondary_color}};color:#fff;border:0}*/
  </style>
  <body>
    <div class="container">
      <div class="alert card" style="display:flex;justify-content:space-between;align-items:center">
        <div>طلب #{{ order.id }} • <span class="muted">الوقت المتوقع 15 دقيقة</span></div>
        <div style="display:flex;gap:8px">
          <a class="btn" href="#" onclick="window.print()">طباعة</a>
          {% if order.branch and order.branch.address %}
            <a class="btn btn-primary" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ order.branch.address|urlencode }}">الاتجاهات</a>
          {% endif %}
        </div>
      </div>

      <!-- Progress -->
      <div class="progress">
        <div class="node {% if order.status == 'Delivered' %}is-active{% endif %}">
          <div class="dot"></div>
          <div class="label">مكتمل</div>
        </div>
        <div class="node {% if order.status == 'Ready' %}is-active{% endif %}">
          <div class="dot"></div>
          <div class="label">جاهز</div>
        </div>
        <div class="node {% if order.status == 'New' or order.status == 'Preparing' %}is-active{% endif %}">
          <div class="dot"></div>
          <div class="label">جاري التحضير</div>
        </div>
      </div>

      <div class="grid">
        <div class="panel card">
          <div class="section" style="border:0;background:transparent">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <b>ملخص الطلب</b>
              <span class="muted">{{ order.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div class="muted">العناصر:</div>
            <ul style="margin:6px 0 0 0;padding:0;list-style:none">
              {% for it in order.items.all %}
                <li style="padding:8px 0;border-bottom:1px dashed #eee;display:flex;justify-content:space-between;gap:8px">
                  <span>{{ it.product.name }} <span class="muted">× {{ it.quantity }}</span></span>
                  <span>SAR {{ it.product.price|floatformat:2 }}</span>
                </li>
                <li>
                </li>
              {% empty %}
                <li class="muted">لا توجد عناصر</li>
              {% endfor %}
            </ul>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
              <span class="muted">الإجمالي</span>
              <span><b>SAR {{ order.total_price }}</b></span>
            </div>
          </div>
        </div>
        <aside class="side">
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <b>تفاصيل الطلب</b>
              <span class="muted">الحالة: {{ order.get_status_display }}</span>
            </div>
            <div class="muted">الفرع</div>
            <div style="margin-bottom:8px">{{ order.branch }}</div>
            <div class="muted">الدفع</div>
            <div>{{ order.get_payment_method_display|default:order.payment_method }}</div>
          </div>
          <div class="section summary">
            <div class="muted">الفرع</div><div>{{ order.branch }}</div>
            <div class="muted">وقت الطلب</div><div>{{ order.created_at|date:"H:i" }}</div>
          </div>
          {% if order.branch and order.branch.address %}
          <div class="section">
            <div class="muted">موقع الفرع</div>
            <div style="margin-top:8px;border-radius:12px;overflow:hidden">
              <iframe
                title="خريطة الفرع"
                width="100%"
                height="200"
                style="border:0"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://www.google.com/maps?q={{ order.branch.address|urlencode }}&output=embed">
              </iframe>
            </div>
          </div>
          {% endif %}
        </aside>
      </div>

      <div class="footer">
        {% if slug %}<a class="btn" href="{% url 'websites:menu' slug %}">العودة للقائمة</a>{% else %}<span></span>{% endif %}
        {% if slug %}<a class="btn btn-primary" href="{% url 'websites:menu' slug %}">أعد الطلب</a>{% endif %}
      </div>
    </div>
    {{ order.id|json_script:"order-id" }}

    
    <script>
      (function(){
        const orderId = JSON.parse(document.getElementById('order-id').textContent);
        const statusEl = document.querySelector('.section .muted + span') || null;
        const nodes = document.querySelectorAll('.progress .node');
        function applyStatus(s){
          nodes.forEach(n=>n.classList.remove('is-active'));
          if(s === 'Delivered') nodes[0].classList.add('is-active');
          if(s === 'Ready') nodes[1].classList.add('is-active');
          if(s === 'New' || s === 'Preparing') nodes[2].classList.add('is-active');
        }
        async function tick(){
          try{
            const res = await fetch('/payments/order-status/' + orderId + '/');
            if(!res.ok) return;
            const data = await res.json();
            if(data && data.ok){ applyStatus(data.status); }
          }catch(e){ /* ignore network errors */ }
        }
        setInterval(tick, 5000);
      })();
    </script>

    
  </body>
</html>


